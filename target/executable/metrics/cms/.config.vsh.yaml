name: "cms"
namespace: "metrics"
version: "build_fix_failed_stuff"
argument_groups:
- name: "Arguments"
  arguments:
  - type: "file"
    name: "--input_unintegrated"
    label: "Unintegrated"
    summary: "The complete unintegrated dataset.\n"
    description: "The complete unintegrated dataset.\nThe cells in this dataset are\
      \ the same to those in the censored dataset.\n"
    info:
      format:
        type: "h5ad"
        layers:
        - type: "double"
          name: "preprocessed"
          description: "preprocessed data, e.g. already compensated, transformed and\
            \ debris/doublets removed"
          required: true
        obs:
        - type: "string"
          name: "cell_type"
          description: "Cell type information"
          required: true
        - type: "string"
          name: "batch"
          description: "Batch information"
          required: true
        - type: "string"
          name: "sample"
          description: "Sample ID"
          required: true
        - type: "string"
          name: "donor"
          description: "Donor ID"
          required: true
        - type: "string"
          name: "group"
          description: "Biological group of the donor"
          required: true
        - type: "integer"
          name: "is_control"
          description: "Whether the sample the cell came from can be used as a control\
            \ for batch \neffect correction.\n\n* 0: cannot be used as a control.\n\
            * >= 1: can be used as a control.\n* For cells with >= 1: cells with the\
            \ same value come from the same donor.\n\nDifferent values indicate different\
            \ donors.\n"
          required: true
        - type: "integer"
          name: "split"
          description: "Which split the cell will be used in.\n\n* 0: control samples\n\
            * 1: split 1\n* 2: split 2\n"
          required: true
        var:
        - type: "integer"
          name: "numeric_id"
          description: "Numeric ID associated with each marker"
          required: true
        - type: "string"
          name: "channel"
          description: "The channel / detector of the instrument"
          required: true
        - type: "string"
          name: "marker"
          description: "The marker name associated with the channel"
          required: false
        - type: "string"
          name: "marker_type"
          description: "Whether the marker is a functional or lineage marker"
          required: true
        - type: "boolean"
          name: "to_correct"
          description: "Whether the marker will be batch corrected"
          required: true
        uns:
        - type: "string"
          name: "dataset_id"
          description: "A unique identifier for the dataset"
          required: true
        - name: "dataset_name"
          type: "string"
          description: "Nicely formatted name."
          required: true
        - type: "string"
          name: "dataset_url"
          description: "Link to the original source of the dataset."
          required: false
        - name: "dataset_reference"
          type: "string"
          description: "Bibtex reference of the paper in which the dataset was published."
          required: false
        - name: "dataset_summary"
          type: "string"
          description: "Short description of the dataset."
          required: true
        - name: "dataset_description"
          type: "string"
          description: "Long description of the dataset."
          required: true
        - name: "dataset_organism"
          type: "string"
          description: "The organism of the sample in the dataset."
          required: false
        - name: "parameter_som_xdim"
          type: "integer"
          description: "Parameter used to define the width of the self-organizing\
            \ map (SOM) grid. Usually between 10 and 20."
          required: true
        - name: "parameter_som_ydim"
          type: "integer"
          description: "Parameter used to define the height of the self-organizing\
            \ map (SOM) grid. Usually between 10 and 20."
          required: true
        - name: "parameter_num_clusters"
          type: "integer"
          description: "Parameter used to define the number of clusters. Set this\
            \ number to be slightly higher than the number of cell types expected\
            \ in the dataset."
          required: true
    example:
    - "resources_test/task_cyto_batch_integration/mouse_spleen_flow_cytometry_subset/unintegrated.h5ad"
    must_exist: true
    create_parent: true
    required: true
    direction: "input"
    multiple: false
    multiple_sep: ";"
  - type: "file"
    name: "--input_integrated_split1"
    label: "Integrated (split 1)"
    summary: "Integrated dataset which batch effect was corrected by an algorithm"
    info:
      format:
        type: "h5ad"
        layers:
        - type: "double"
          name: "integrated"
          description: "The integrated data as returned by a batch correction method"
          required: true
        uns:
        - type: "string"
          name: "dataset_id"
          description: "A unique identifier for the dataset"
          required: true
        - type: "string"
          name: "method_id"
          description: "A unique identifier for the method"
          required: true
        - type: "object"
          name: "parameters"
          description: "The parameters used for the integration"
          required: false
    example:
    - "resources_test/task_cyto_batch_integration/mouse_spleen_flow_cytometry_subset/integrated_split1.h5ad"
    must_exist: true
    create_parent: true
    required: true
    direction: "input"
    multiple: false
    multiple_sep: ";"
  - type: "file"
    name: "--input_integrated_split2"
    label: "Integrated (split 2)"
    summary: "Integrated dataset which batch effect was corrected by an algorithm"
    info:
      format:
        type: "h5ad"
        layers:
        - type: "double"
          name: "integrated"
          description: "The integrated data as returned by a batch correction method"
          required: true
        uns:
        - type: "string"
          name: "dataset_id"
          description: "A unique identifier for the dataset"
          required: true
        - type: "string"
          name: "method_id"
          description: "A unique identifier for the method"
          required: true
        - type: "object"
          name: "parameters"
          description: "The parameters used for the integration"
          required: false
    example:
    - "resources_test/task_cyto_batch_integration/mouse_spleen_flow_cytometry_subset/integrated_split2.h5ad"
    must_exist: true
    create_parent: true
    required: true
    direction: "input"
    multiple: false
    multiple_sep: ";"
  - type: "file"
    name: "--output"
    label: "Score"
    summary: "File indicating the score of a metric."
    info:
      format:
        type: "h5ad"
        uns:
        - type: "string"
          name: "dataset_id"
          description: "A unique identifier for the dataset"
          required: true
        - type: "string"
          name: "method_id"
          description: "A unique identifier for the batch correction method"
          required: true
        - type: "string"
          name: "metric_ids"
          description: "One or more unique metric identifiers"
          multiple: true
          required: true
        - type: "double"
          name: "metric_values"
          description: "The metric values obtained. Must be of same length as 'metric_ids'."
          multiple: true
          required: true
    example:
    - "resources_test/task_cyto_batch_integration/mouse_spleen_flow_cytometry_subset/score.h5ad"
    must_exist: true
    create_parent: true
    required: true
    direction: "output"
    multiple: false
    multiple_sep: ";"
  - type: "integer"
    name: "--n_neighbors"
    description: "Number of k-nearest neighbours (knn) to use when computing cms scores."
    info: null
    default:
    - 50
    required: false
    direction: "input"
    multiple: false
    multiple_sep: ";"
  - type: "integer"
    name: "--n_dim"
    description: "Number of principal components to use when computing cms scores."
    info: null
    default:
    - 10
    required: false
    direction: "input"
    multiple: false
    multiple_sep: ";"
resources:
- type: "r_script"
  path: "script.R"
  is_executable: true
- type: "file"
  path: "helper_functions.R"
test_resources:
- type: "python_script"
  path: "run_and_check_output.py"
  is_executable: true
- type: "python_script"
  path: "check_config.py"
  is_executable: true
- type: "file"
  path: "resources_test/task_cyto_batch_integration/mouse_spleen_flow_cytometry_subset"
  dest: "resources_test/task_cyto_batch_integration/mouse_spleen_flow_cytometry_subset"
info:
  metrics:
  - name: "cms"
    label: "Cell Mixing Score"
    summary: "Cellspecific Mixing Score (cms) quantifies batch effects at the cell\
      \ level by computing batch-specific distance distributions towards k-nearest\
      \ neighbouring cells."
    description: "The cellspecific mixing score cms tests for each cell the hypothesis\
      \ that batch-specific distance \ndistributions towards it's k-nearest neighbouring\
      \ (knn) cells are derived from the same unspecified \nunderlying distribution\
      \ using the Anderson-Darling test. The test considers differences in the number\
      \ of cells \nfrom each batch, making the cms a robust metric when evaluating\
      \ batch effects in datasets with unbalanced batch sizes.\nThis implementation\
      \ uses k = 50 knn cells and the first 10 principal components for distance computations.\n\
      \nThe cms for each cell can be interpreted as a P-value, that is, the probability\
      \ of observing deviations \nin the batch specific distance distributions by\
      \ chance (assuming they are all derived from the same distribution).\nTherefore,\
      \ for a given cell:\n- A low cms score indicates that the batch-specific distance\
      \ distributions towards its knn cells are significantly different, \n  suggesting\
      \ that the cell is influenced by batch effects.\n- A high cms score indicates\
      \ that the batch-specific distance distributions towards its knn cells are similar,\
      \ \n  suggesting that the cell is not influenced by batch effects.\n\n\nTo characterize\
      \ the overall batch mixing in a dataset, we use the medcouple statistic on the\
      \ distribution of cms scores.\nThe medcouple is a robust measure of skewness,\
      \ which is less sensitive to outliers than the traditional skewness measure.\n\
      The medcouple statistic returns values between -1 and 1, where:\n- A value close\
      \ to -1 indicates a pronounced left-skewed distribution, reflecting abundance\
      \ of cells with high cms scores\n- A value close to 1 indicates a pronounced\
      \ right-skewed distribution, reflecting abundance of cells with low cms scores\n\
      - A value around 0 indicates a symmetrical distribution of cms scores\n\nIt\
      \ has been empirically observed that a uniform (thus, symmetrical) distribution\
      \ of cms scores across cells in a dataset is indicative of good mixing\n(e.g.\
      \ via random shuffling of batch labels in a dataset). Therefore, a medcouple\
      \ around 0 or lower is considered a good mixing score.\n\nIn this implementation\
      \ we subset to 60% of the total cells in each split of the technical replicates.\
      \ The subset is stratified by cell type and sample.\nThe mean medcouple between\
      \ the two splits of technical replicates is used as the final score.\n"
    references:
      doi:
      - "10.26508/lsa.202001004"
      bibtex:
      - "@article{lutge2021cellmixs,\n  title={CellMixS: quantifying and visualizing\
        \ batch effects in single-cell RNA-seq data},\n  author={L{\\\"u}tge, Almut\
        \ and Zyprych-Walczak, Joanna and Kunzmann, Urszula Brykczynska and Crowell,\
        \ Helena L and Calini, Daniela and Malhotra, Dheeraj and Soneson, Charlotte\
        \ and Robinson, Mark D},\n  journal={Life science alliance},\n  volume={4},\n\
        \  number={6},\n  year={2021},\n  publisher={Life Science Alliance}\n}\n"
      - "@article{brys2004robust,\n  title={A robust measure of skewness},\n  author={Brys,\
        \ Guy and Hubert, Mia and Struyf, Anja},\n  journal={Journal of Computational\
        \ and Graphical Statistics},\n  volume={13},\n  number={4},\n  pages={996--1017},\n\
        \  year={2004},\n  publisher={Taylor \\& Francis}\n}\n"
    links:
      documentation: "https://bioconductor.org/packages/release/bioc/html/CellMixS.html"
      repository: "https://github.com/almutlue/CellMixS"
    min: -1
    max: 1
    maximize: false
  type: "metric"
  type_info:
    label: "Metric"
    summary: "A task template metric."
    description: "A metric for evaluating method predictions.\n"
status: "enabled"
scope:
  image: "public"
  target: "public"
repositories:
- type: "github"
  name: "op"
  repo: "openproblems-bio/openproblems"
  tag: "build/main"
license: "MIT"
links:
  repository: "https://github.com/openproblems-bio/task_cyto_batch_integration"
  docker_registry: "ghcr.io"
runners:
- type: "executable"
  id: "executable"
  docker_setup_strategy: "ifneedbepullelsecachedbuild"
- type: "nextflow"
  id: "nextflow"
  directives:
    label:
    - "midtime"
    - "midmem"
    - "midcpu"
    tag: "$id"
  auto:
    simplifyInput: true
    simplifyOutput: false
    transcript: false
    publish: false
  config:
    labels:
      lowmem: "memory = 20.Gb"
      midmem: "memory = 50.Gb"
      highmem: "memory = 100.Gb"
      lowcpu: "cpus = 5"
      midcpu: "cpus = 15"
      highcpu: "cpus = 30"
      lowtime: "time = 1.h"
      midtime: "time = 4.h"
      hightime: "time = 8.h"
      veryhightime: "time = 24.h"
  debug: false
  container: "docker"
engines:
- type: "docker"
  id: "docker"
  image: "openproblems/base_r:1"
  namespace_separator: "/"
  setup:
  - type: "r"
    packages:
    - "robustbase"
    - "rhdf5"
    bioc:
    - "CellMixS"
    - "SingleCellExperiment"
    - "Biocparallel"
    github:
    - "scverse/anndataR@0.99.0"
    bioc_force_install: false
    warnings_as_errors: true
  entrypoint: []
  cmd: null
build_info:
  config: "src/metrics/cms/config.vsh.yaml"
  runner: "executable"
  engine: "docker"
  output: "target/executable/metrics/cms"
  executable: "target/executable/metrics/cms/cms"
  viash_version: "0.9.4"
  git_commit: "18a7440ffb76b02ebd3f03f76a7ee6fb7140fb2a"
  git_remote: "https://github.com/openproblems-bio/task_cyto_batch_integration"
package_config:
  name: "task_cyto_batch_integration"
  version: "build_fix_failed_stuff"
  label: "Cyto Batch Integration"
  summary: "Benchmarking of batch integration algorithms for cytometry data."
  description: "Cytometry is a non-sequencing single cell profiling technique commonly\
    \ used in clinical studies. \nIt is very sensitive to batch effects, which can\
    \ lead to biases in the interpretation of the result. \nBatch integration algorithms\
    \ are often used to mitigate this effect.\n\nIn this project, we are building\
    \ a pipeline for reproducible and continuous benchmarking \nof batch integration\
    \ algorithms for cytometry data.\nAs input, methods require cleaned and normalised\
    \ (using arc-sinh or logicle transformation)\ndata with multiple batches, cell\
    \ type labels, and biological subjects, with paired samples\nfrom a subject profiled\
    \ across multiple batches.\nThe batch integrated output must be an integrated\
    \ marker by cell matrix stored in \nAnndata format.\nAll markers in the input\
    \ data must be returned, regardless of whether they were integrated or not.\n\
    This output is then evaluated using metrics that assess how well the batch effects\n\
    were removed and how much biological signals were preserved. \n"
  info:
    image: "The name of the image file to use for the component on the website."
    test_resources:
    - type: "s3"
      path: "s3://openproblems-data/resources_test/task_cyto_batch_integration/"
      dest: "resources_test/task_cyto_batch_integration"
  repositories:
  - type: "github"
    name: "op"
    repo: "openproblems-bio/openproblems"
    tag: "build/main"
  viash_version: "0.9.4"
  source: "src"
  target: "target"
  config_mods:
  - ".runners[.type == \"nextflow\"].config.labels := { lowmem : \"memory = 20.Gb\"\
    , midmem : \"memory = 50.Gb\", highmem : \"memory = 100.Gb\", lowcpu : \"cpus\
    \ = 5\", midcpu : \"cpus = 15\", highcpu : \"cpus = 30\", lowtime : \"time = 1.h\"\
    , midtime : \"time = 4.h\", hightime : \"time = 8.h\", veryhightime : \"time =\
    \ 24.h\" }\n"
  authors:
  - name: "Luca Leomazzi"
    roles:
    - "author"
    - "maintainer"
    info:
      github: "LuLeom"
  - name: "Givanna Putri"
    roles:
    - "author"
    - "maintainer"
    info:
      github: "ghar1821"
      orcid: "0000-0002-7399-8014"
  - name: "Robrecht Cannoodt"
    roles:
    - "author"
    info:
      github: "rcannood"
      orcid: "0000-0003-3641-729X"
  - name: "Katrien Quintelier"
    roles:
    - "contributor"
    info:
      github: "KatrienQ"
  - name: "Sofie Van Gassen"
    roles:
    - "contributor"
    info:
      github: "SofieVG"
  keywords:
  - "single-cell"
  - "openproblems"
  - "benchmark"
  license: "MIT"
  organization: "openproblems-bio"
  links:
    repository: "https://github.com/openproblems-bio/task_cyto_batch_integration"
    docker_registry: "ghcr.io"
    issue_tracker: "https://github.com/openproblems-bio/task_cyto_batch_integration/issues"
